name: Build single DLL

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Find project or create temp classlib and build
        id: build
        shell: bash
        run: |
          set -euo pipefail

          echo "Searching for a .csproj in the repo..."
          CSPROJ=$(find . -type f -name '*.csproj' -not -path './.git/*' | head -n 1 || true)
          echo "DEBUG: CSPROJ='$CSPROJ'"

          if [ -n "$CSPROJ" ]; then
            echo "Found .csproj: $CSPROJ"
            dotnet restore "$CSPROJ"
            dotnet build "$CSPROJ" -c Release -o ./artifacts --no-restore
          else
            echo "No .csproj found. Creating temporary class library and compiling all .cs files into one DLL."
            rm -rf temp_build artifacts || true
            dotnet new classlib -o temp_build -n TempBuild --framework net6.0
            rm -f temp_build/Class1.cs || true

            # Copy all .cs files into the temp project (exclude .git, temp_build, bin and obj)
            find . -type f -name '*.cs' \
              -not -path './.git/*' \
              -not -path './temp_build/*' \
              -not -path '*/bin/*' \
              -not -path '*/obj/*' \
              -print0 | xargs -0 -I{} cp "{}" temp_build/ || true

            if [ -z "$(ls -A temp_build/*.cs 2>/dev/null || true)" ]; then
              cat > temp_build/Placeholder.cs <<'EOF'
namespace TempBuildPlaceholder { public class Placeholder { public static void Nothing() {} } }
EOF
            fi

            dotnet restore ./temp_build/TempBuild.csproj || true
            dotnet build ./temp_build/TempBuild.csproj -c Release -o ./artifacts
            CSPROJ=./temp_build/TempBuild.csproj
            echo "Built temp project at $CSPROJ"
          fi

          echo "Artifacts directory listing:"
          ls -la artifacts || true

          echo "csproj=$CSPROJ" >> "$GITHUB_OUTPUT"
          echo "artifact_dir=artifacts" >> "$GITHUB_OUTPUT"

      - name: Show possible output locations (debug)
        if: always()
        run: |
          echo "Artifacts contents:"
          ls -R artifacts || true
          echo "Release folders:"
          find . -type d -name 'Release' -prune -print -exec ls -la {} \; || true

      - name: Find built DLL
        id: find_dll
        shell: bash
        run: |
          set -euo pipefail
          # First look in the artifacts output dir
          DLL=$(find artifacts -type f -name '*.dll' -print -quit || true)
          # If not found, search for common Release output folders
          if [ -z "$DLL" ]; then
            DLL=$(find . -type f \( -path '*/bin/Release/**/net*/*.dll' -o -path './artifacts/*.dll' \) -print -quit || true)
          fi
          if [ -z "$DLL" ]; then
            echo "No DLL found. Listing likely locations for debugging:"
            find . -type f -name '*.dll' -print || true
            exit 1
          fi
          echo "Found DLL: $DLL"
          echo "dll_path=$DLL" >> "$GITHUB_OUTPUT"
          echo "asset_name=$(basename "$DLL")" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release (for direct DLL download)
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: build-${{ github.run_id }}
          release_name: Build ${{ github.run_number }} (run ${{ github.run_id }})
          body: "Automated build release for run ${{ github.run_id }} â€” contains compiled DLL."
          draft: false
          prerelease: false

      - name: Upload DLL as release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_dll.outputs.dll_path }}
          asset_name: ${{ steps.find_dll.outputs.asset_name }}
          asset_content_type: application/octet-stream

      - name: Cleanup (optional)
        if: always()
        run: |
          echo "Release created: ${{ steps.create_release.outputs.html_url }}"
          echo "Asset uploaded: ${{ steps.find_dll.outputs.asset_name }}"

      - name: Done
        if: success()
        run: echo "Build + release complete. Visit the release page to download the DLL: ${{ steps.create_release.outputs.html_url }}"
